<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Ottawa cycling stress map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src="myturf.min.js"></script>
    <script src="geojson-rbush.min.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.0/mapbox-gl.css' rel='stylesheet' />
    <link href='https://www.mapbox.com/base/latest/base.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
</head>
<body>

<div id='map'></div>
<div id='legendbtn' class='pin-right pad2 '>
  <a href='#legend' class='button' onclick="document.getElementById('legendbtn').style.display='none'">Legend</a>
</div>
<div id='legend' class='col4 pad2 row7 pin-right offcanvas-right '>
  <a href='#' class='fill-darken2 pad1 icon close button fr' onclick="document.getElementById('legendbtn').style.display='block'"></a>
  <div class='clearfix'></div>
  <form>
    <h5>Street legend</h5>
    <fieldset class='checkbox-pill clearfix '>
      <input type='checkbox' id='legend-lts1'>
      <label for='legend-lts1' id='legend-lts1-label' class='button icon check quiet col12' style="text-align:left;">LTS-1</label>
      <input type='checkbox' id='legend-lts2'>
      <label for='legend-lts2' id='legend-lts2-label' class='button icon check quiet col12' style="text-align:left;">LTS-2</label>
      <input type='checkbox' id='legend-lts3'>
      <label for='legend-lts3' id='legend-lts3-label' class='button icon check quiet col12' style="text-align:left;">LTS-3</label>
      <input type='checkbox' id='legend-lts4'>
      <label for='legend-lts4' id='legend-lts4-label' class='button icon check quiet col12' style="text-align:left;">LTS-4</label>
    </fieldset>

  </form>
</div>


<script>
var ltsLayers = [
    {id:"legend-lts1", url: 'data/level_1.json', name:'LTS 1 - Suitable for children', color:'#0099cc', opacity:0.5, tileset:'mapbox://zzptichka.53bf2frg', layer:'level_1-45ccc2'},
    {id:"legend-lts2", url: 'data/level_2.json', name:'LTS-2 - Low stress', color:'#1C7C54', opacity:0.5, tileset:'mapbox://zzptichka.771hbw7i', layer:'level_2-18vk61'},
    {id:"legend-lts3", url: 'data/level_3.json', name:'LTS-3 - Medium stress', color:'#F0C808', opacity:0.5, tileset:'mapbox://zzptichka.5jgkszgd', layer:'level_3-97ctwn'},
    {id:"legend-lts4", url: 'data/level_4.json', name:'LTS-4 - High stress', color:'#DD5454', opacity:0.5, tileset:'mapbox://zzptichka.4ioiilcy', layer:'level_4-b8wity'}
  ];

const tree = rbush.rbush();

mapboxgl.accessToken = 'pk.eyJ1IjoienpwdGljaGthIiwiYSI6ImNqN2FubTQ5ejBpZDAyd285MmZsdHN3d3IifQ.dc6SvmJLcl7KGPQlBYFj-g';
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v8',
    center: [-75.697927,45.417431],
    zoom: 13
});

function toggleLayer (checkbox) {
    map.setLayoutProperty(checkbox.currentTarget.id, 'visibility', checkbox.currentTarget.checked?'visible':'none');
  }

document.getElementById('legend-lts1').onclick = toggleLayer
document.getElementById('legend-lts2').onclick = toggleLayer
document.getElementById('legend-lts3').onclick = toggleLayer
document.getElementById('legend-lts4').onclick = toggleLayer

function addStressLayerToMap (layer) {
  const xhr = new XMLHttpRequest()
  xhr.open('GET', layer.url)
  xhr.setRequestHeader('Content-Type', 'application/json')
  xhr.onload = function () {
    if (xhr.status === 200) {
      const data = JSON.parse(xhr.responseText)
      tree.load(data)

    } else {
      alert('Request failed.  Returned status of ' + xhr.status)
    }
  }
  xhr.send()
}

map.on('style.load', function () {

    ltsLayers.forEach(function (layer, i) {

      addStressLayerToMap(layer)

    map.addLayer({
      "id": layer.id,
      "type": "line",
      "source": {
          type: 'vector',
          url: layer.tileset,
      },
      "source-layer": layer.layer,
      "layout": {
          "line-join": "round",
          "line-cap": "round"
      },
      "paint": {
          "line-color": layer.color,
          "line-width": 2,
          "line-opacity": layer.opacity
      }
    });
    map.setLayoutProperty(layer.id, 'visibility', 'none');
    document.getElementById(layer.id+'-label').innerHTML = '<span style="display: inline-block;width:50px; height:8px;background-color: '+layer.color+'"></span>&nbsp;'+layer.name;
  });

});


function getFeaturesNearby(point, maxMeters, breakOnFirst)
{
  ret = [];
  const pt = turf.helpers.point(point);
  const nearby = tree.search(pt);
  for(let feature of nearby.features){
    if(breakOnFirst && ret.length){return ret;}
    const line = turf.helpers.lineString(feature.geometry.coordinates);
    if(turf.pointToLineDistance(pt, line, {units: 'meters'})<maxMeters){
      ret.push(feature);
    }
  }

  return ret;
}


function displayOsmElementInfo(element, lngLat) {

  const xhr = new XMLHttpRequest()
  xhr.open('GET','https://api.openstreetmap.org/api/0.6/'+element)
  xhr.onload = function () {
    let popup = '<b><a href="https://www.openstreetmap.org/' + element + '" target="_blank">' + element + '</a></b><hr>'
    if (xhr.status === 200) {
      const xmlDOM = new DOMParser().parseFromString(xhr.responseText, 'text/xml');
      const tags = xmlDOM.getElementsByTagName("tag");
      for(let i=0; i<tags.length; i++)
      {
        popup += tags[i].attributes["k"].value+": <b>"+tags[i].attributes["v"].value+'</b><br>';
      }
    } else {
      popup += 'Failed to request details from osm.org';
    }
    map.openPopup(popup, lngLat);
  }
  xhr.send()
}


let highlight;
let timer;
map.on('mousemove', function(e) {
  const features = getFeaturesNearby([e.lngLat.lng,e.lngLat.lat], 5, true)
  clearTimeout(timer);
  if (features.length!=0) {
    document.getElementById('map').style.cursor = 'pointer'
  }
  else {
    timer = setTimeout(function()
                {
	                 document.getElementById('map').style.cursor = ''
                 }, 100);
  }
})

map.on('click', function(e) {
  if (highlight){
    map.removeLayer(highlight)
  }
  const features = getFeaturesNearby([e.lngLat.lng,e.lngLat.lat], 5, true);
  if (features.length!=0) {
    displayOsmElementInfo(features[0].id, e.lngLat);
    highlight = new L.geoJson(features[0],{style: {color:'#df42f4',  weight: 5}}).addTo(map);
    map.on('popupclose', function() {
     map.removeLayer(highlight)
   });
  }
 });


</script>

</body>
</html>
